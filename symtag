#!/bin/bash

# This program is free software. It comes without any warranty, to the extent
# permitted by applicable law. You can redistribute it and/or modify it under
# the terms of the Do What The Fuck You Want To Public License, Version 2, as
# published by Sam Hocevar. See WTFPL.txt or http://www.wtfpl.net/ for more
# details.

shopt -s expand_aliases
alias fail='{ echo $LINENO; exit 1; }'


function link_file {
  test -e "${SYMTAGDIR}/files/${HASH}" || {
    test -h "${SYMTAGDIR}/files/${HASH}" && {
      rm "${SYMTAGDIR}/files/${HASH}" || fail
    }
    ln -s "$(realpath --relative-to "${SYMTAGDIR}/files/" "${FILE}" || fail )" "${SYMTAGDIR}/files/${HASH}" || fail
  }
}


function name_file {
  test -e "${SYMTAGDIR}/names/${NAME}" || {
    test -h "${SYMTAGDIR}/names/${NAME}" && {
      rm "${SYMTAGDIR}/names/${NAME}" || fail
    }
    ln -s "../files/${HASH}" "${SYMTAGDIR}/names/${NAME}" || fail
  }
}


function tag_file {
  mkdir -p "${SYMTAGDIR}/tags/${TAG}" || fail
  test -h "${SYMTAGDIR}/tags/${TAG}/${HASH}" && {
    rm "${SYMTAGDIR}/tags/${TAG}/${HASH}" || fail
  }
  ln -s "../../files/${HASH}" "${SYMTAGDIR}/tags/${TAG}/${HASH}" || fail
}


function boolean_or {
  RESULTS+=("${TAGGED_FILES[@]}")
}


function boolean_and {
  NEW_RESULTS=()
  for RESULT in "${RESULTS[@]}"; do
    for TAGGED_FILE in "${TAGGED_FILES[@]}"; do
      if test "${RESULT}" == "${TAGGED_FILE}"; then
        NEW_RESULTS+=("${RESULT}")
      fi
    done
  done
  RESULTS=( "${NEW_RESULTS[@]}" )
}


function boolean_not {
  NEW_RESULTS=()
  for RESULT in "${RESULTS[@]}"; do
    MATCH=no
    for TAGGED_FILE in "${TAGGED_FILES[@]}"; do
      if test "${RESULT}" == "${TAGGED_FILE}"; then
        MATCH=yes
      fi
    done
    if test "${MATCH}" == no; then
      NEW_RESULTS+=( "${RESULT}" )
    fi
  done
  RESULTS=( "${NEW_RESULTS[@]}" )
}


function output_names {
  for RESULT in "${RESULTS[@]}"; do
    ALL_NAMES=( $(ls "${SYMTAGDIR}/names/") )
    for NAME in "${ALL_NAMES[@]}"; do
      DEST=$(readlink "${SYMTAGDIR}/names/${NAME}" | sed 's#^.*/##g')
      if test "${DEST}" == "${RESULT}"; then
        echo "${NAME}"
      fi
    done
  done
}


SYMTAGRC=~/.symtagrc
SYMTAGDIR=~/.symtag

TARGETS=()
TAGS=()
NAMES=()
RESULTS=()

MODE=OR

while test $# -gt 0; do
  case "${1}" in
    -c|--config|--rc)
      SYMTAGRC="${2}"
      shift
      ;;
    -n|--name)
      NAMES+=("${2}")
      ;;
    -t|--tag)
      TAGS+=("${2}")
      shift
      ;;
    -q|--query)
      QUERY="${2}"
      shift
      ;;
    -*)
      fail
      ;;
    *)
      FILES+=("${1}")
      true
      ;;
  esac
  shift
done

test -f "${SYMTAGRC}" && {
  . "${SYMTAGRC}" || fail
}

mkdir -p "${SYMTAGDIR}/"{tags,names,files} || fail

for FILE in "${FILES[@]}"; do 
  HASH=$(sha256sum "${FILE}" | { read HASH PATH; echo $HASH; }) || fail
  NAME=$(echo "${FILE}" | sed 's#^.*/##g') || fail
  NAMES+=($NAME)
  link_file
  name_file
done

for NAME in "${NAMES[@]}"; do
  test -h "${SYMTAGDIR}/names/${NAME}" && {
    HASH=$(readlink "${SYMTAGDIR}/names/${NAME}" | sed 's#^.*/##g') || fail
    for TAG in "${TAGS[@]}"; do
      tag_file
    done
  }
done

for ELEMENT in $QUERY; do
  case "${ELEMENT}" in
    AND|OR|NOT)
      MODE="${ELEMENT}"
      continue
      ;;
    *)
      TAGGED_FILES=( $(test -d "${SYMTAGDIR}/tags/${ELEMENT}/" && ls "${SYMTAGDIR}/tags/${ELEMENT}/") )
      case "${MODE}" in
        OR)
          boolean_or
          ;;
        AND)
          boolean_and
          ;;
        NOT)
          boolean_not
          ;;
        *)
          fail
          ;;
      esac
      ;;
  esac
done

output_names
